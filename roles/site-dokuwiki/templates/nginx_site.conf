# This file is automaticaly generated by Ansible
# please do not change any variable in this config file
# or will be override by ansible.

server {
  listen 80;
  server_name {{ WIKI_DOMAIN }};
  root {{ WEB_PATH }}/{{ SITE_NAME }};

  client_max_body_size 5M;
  client_body_buffer_size 128k;

  access_log  /var/log/nginx/{{ SITE_NAME }}-access.log;
  error_log  /var/log/nginx/{{ SITE_NAME }}-error.log;

  index doku.php;
  autoindex off;

  location / {
    try_files $uri $uri/ @dokuwiki;
  }

  location ~ ^/lib.*\.(gif|png|ico|jpg)$ {
    expires 10d;
  }

  location @dokuwiki {
    rewrite ^/_media/(.*) /lib/exe/fetch.php?media=$1 last;
    rewrite ^/_detail/(.*) /lib/exe/detail.php?media=$1 last;
    rewrite ^/_export/([^/]+)/(.*) /doku.php?do=export_$1&id=$2 last;
    rewrite ^/(.*) /doku.php?id=$1 last;
  }

  location ~ \.php {
    try_files $uri =404;
    fastcgi_intercept_errors on;
    fastcgi_ignore_client_abort off;
    fastcgi_connect_timeout 60;
    fastcgi_send_timeout 180;
    fastcgi_read_timeout 180;
    fastcgi_index  index.php;
    include        fastcgi_params;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    fastcgi_pass   unix:/run/php-fpm/www.sock;
  }

  location ~ /(data|conf|bin|inc)/ {
    deny all;
  }

  location /\.ht {
    deny all;
  }

}
